<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget Fixe Mensuel</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root{
      --bg:#0b1020;--card:#121a2f;--muted:#7a88a8;--text:#e6ecff;--brand:#0ea5e9;--good:#10b981;--bad:#ef4444;--shadow:rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 600px at 80% -10%, rgba(14,165,233,.15), transparent 60%), var(--bg); color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:12px}
    .title{font-weight:800;letter-spacing:.2px;font-size:clamp(22px,4vw,28px)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); border:1px solid rgba(255,255,255,.08); box-shadow:0 8px 30px var(--shadow); border-radius:16px; padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input,button{font:inherit;color:inherit}
    input[type="number"], input[type="text"], input[type="month"]{width:100%; border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0d1426;padding:12px 14px;outline:none}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg, rgba(14,165,233,.18), rgba(14,165,233,.05));padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:transparent}
    .btn.danger{background:linear-gradient(180deg, rgba(239,68,68,.25), rgba(239,68,68,.07)); border-color: rgba(239,68,68,.5)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{color:var(--muted);font-size:12px;text-align:left;padding:0 8px}
    td{background:#0d1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-left:none;border-right:none}
    td:first-child{border-radius:12px 0 0 12px;border-left:1px solid rgba(255,255,255,.08)}
    td:last-child{border-radius:0 12px 12px 0;border-right:1px solid rgba(255,255,255,.08)}
    .amount{text-align:right;font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
    .kpi{background:#0d1426;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:800;font-size:20px}
    footer{opacity:.8;font-size:12px;margin-top:18px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">üìä Budget fixe mensuel</div>
      <div class="toolbar">
        <button class="btn secondary" id="exportBtn">‚¨áÔ∏è Export</button>
        <label class="btn secondary" for="importFile">‚¨ÜÔ∏è Import</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div>
          <label for="monthPicker">Mois</label>
          <input type="month" id="monthPicker" />
        </div>
        <div>
          <label for="incomeInput">Revenus du mois (‚Ç¨)</label>
          <input type="number" id="incomeInput" step="0.01" placeholder="2000" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div>
          <label for="savingsInput">Objectif √©pargne (‚Ç¨)</label>
          <input type="number" id="savingsInput" step="0.01" placeholder="700" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="saveHeader">üíæ Enregistrer</button>
          <button class="btn danger" id="resetMonth">R√©initialiser le mois</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;font-size:16px">D√©penses fixes</h3>
        <button class="btn" id="addRow">+ Ajouter une ligne</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:40%">Libell√©</th>
            <th style="width:25%">Cat√©gorie (optionnel)</th>
            <th style="width:25%" class="amount">Montant (‚Ç¨)</th>
            <th style="width:10%"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Revenus</div>
          <div class="value" id="kpiIncome">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">D√©penses fixes</div>
          <div class="value" id="kpiFixed">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Reste apr√®s d√©penses</div>
          <div class="value" id="kpiAfterFixed">‚Äî</div>
        </div>
      </div>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi">
          <div class="label">Objectif √©pargne</div>
          <div class="value" id="kpiSavings">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">Reste apr√®s √©pargne</div>
          <div class="value" id="kpiLeft" style="color:var(--good)">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="label">√âtat</div>
          <div class="value" id="kpiStatus">‚Äî</div>
        </div>
      </div>
    </section>

    <footer>Astuce : Clique sur une cellule pour √©diter. Tout est sauvegard√© automatiquement sur cet appareil (localStorage) par mois. Export/Import pour sauvegarder ailleurs.</footer>
  </div>

  <script>
  // ====== Utilitaires ======
  const EUR = new Intl.NumberFormat('fr-FR',{style:'currency', currency:'EUR'});
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const toMonthKey = (dateISO)=> (dateISO || todayISO()).slice(0,7);

  // ====== Donn√©es ======
  const KEY = 'fixedBudget_v1';
  let state = load();
  function load(){
    try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw);}catch{}
    return { months:{} };
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function ensureMonth(m){ if(!state.months[m]){ state.months[m] = { income: 0, savings: 0, rows: [] }; save(); } }

  // ====== El√©ments ======
  const monthPicker = document.getElementById('monthPicker');
  const incomeInput = document.getElementById('incomeInput');
  const savingsInput = document.getElementById('savingsInput');
  const saveHeader = document.getElementById('saveHeader');
  const resetMonth = document.getElementById('resetMonth');
  const addRowBtn = document.getElementById('addRow');
  const tbody = document.getElementById('tbody');
  const kpiIncome = document.getElementById('kpiIncome');
  const kpiFixed = document.getElementById('kpiFixed');
  const kpiAfterFixed = document.getElementById('kpiAfterFixed');
  const kpiSavings = document.getElementById('kpiSavings');
  const kpiLeft = document.getElementById('kpiLeft');
  const kpiStatus = document.getElementById('kpiStatus');
  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');

  let currentMonth = toMonthKey();

  // ====== Rendu ======
  function render(){
    ensureMonth(currentMonth);
    const m = state.months[currentMonth];

    monthPicker.value = currentMonth;
    incomeInput.value = m.income || '';
    savingsInput.value = m.savings || '';

    tbody.innerHTML = '';
    m.rows.forEach(row => tbody.appendChild(renderRow(row)));

    const totalFixed = sumFixed(m.rows);
    const afterFixed = (Number(m.income)||0) - totalFixed;
    const left = afterFixed - (Number(m.savings)||0);

    kpiIncome.textContent = EUR.format(Number(m.income)||0);
    kpiFixed.textContent = EUR.format(totalFixed);
    kpiAfterFixed.textContent = EUR.format(afterFixed);
    kpiSavings.textContent = EUR.format(Number(m.savings)||0);
    kpiLeft.textContent = EUR.format(left);
    kpiLeft.style.color = left >= 0 ? 'var(--good)' : 'var(--bad)';
    kpiStatus.textContent = left >= 0 ? 'OK ‚úÖ' : 'D√©passement ‚ùå';
  }

  function renderRow(row){
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td');
    const tdCat = document.createElement('td');
    const tdAmount = document.createElement('td'); tdAmount.className='amount';
    const tdActions = document.createElement('td');

    const inpLabel = document.createElement('input'); inpLabel.type='text'; inpLabel.value=row.label||''; inpLabel.placeholder='Loyer, Assurance, Tel‚Ä¶';
    const inpCat = document.createElement('input'); inpCat.type='text'; inpCat.value=row.category||''; inpCat.placeholder='Maison, Banque‚Ä¶';
    const inpAmt = document.createElement('input'); inpAmt.type='number'; inpAmt.step='0.01'; inpAmt.min='0'; inpAmt.style=textRight(); inpAmt.value=row.amount ?? '';

    inpLabel.addEventListener('input', ()=>{ row.label = inpLabel.value; persist(); });
    inpCat.addEventListener('input',   ()=>{ row.category = inpCat.value; persist(); });
    inpAmt.addEventListener('input',   ()=>{ row.amount = toNumber(inpAmt.value); persist(); });

    const del = document.createElement('button'); del.className='btn danger'; del.textContent='üóëÔ∏è';
    del.addEventListener('click', ()=>{ removeRow(row.id); });

    tdLabel.appendChild(inpLabel);
    tdCat.appendChild(inpCat);
    tdAmount.appendChild(inpAmt);
    tdActions.appendChild(del);
    tr.append(tdLabel, tdCat, tdAmount, tdActions);
    return tr;
  }

  function textRight(){ return 'text-align:right;width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0d1426;padding:12px 14px;outline:none'; }
  function toNumber(v){ const n = Number(v); return isFinite(n) ? +n.toFixed(2) : 0; }
  function sumFixed(rows){ return rows.reduce((s,r)=> s + (Number(r.amount)||0), 0); }

  // ====== Actions ======
  function addRow(){
    const m = state.months[currentMonth];
    m.rows.push({ id: uid(), label:'', category:'', amount:0 });
    persist();
  }
  function removeRow(id){
    const m = state.months[currentMonth];
    m.rows = m.rows.filter(r=> r.id !== id);
    persist();
  }
  function saveHeaderValues(){
    const m = state.months[currentMonth];
    m.income = toNumber(incomeInput.value);
    m.savings = toNumber(savingsInput.value);
    persist();
  }
  function persist(){ save(); render(); }
  function uid(){ return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,7); }

  // ====== Export / Import ======
  function doExport(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='budget-fixe.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
  }
  function doImport(file){
    const reader = new FileReader(); reader.onload = ()=>{
      try{ const incoming = JSON.parse(reader.result); if(!incoming || !incoming.months) throw new Error('Format invalide'); state = incoming; save(); render(); alert('Import r√©ussi ‚úÖ'); }
      catch(e){ alert('√âchec import : '+(e.message||e)); }
    }; reader.readAsText(file);
  }

  // ====== Init ======
  function init(){
    monthPicker.value = currentMonth;
    ensureMonth(currentMonth);
    render();

    monthPicker.addEventListener('change', (e)=>{ const v=e.target.value; if(/^\d{4}-\d{2}$/.test(v)){ currentMonth=v; render(); }});
    saveHeader.addEventListener('click', saveHeaderValues);
    resetMonth.addEventListener('click', ()=>{ if(confirm('Effacer toutes les lignes de ce mois ?')){ state.months[currentMonth].rows=[]; save(); render(); }});
    addRowBtn.addEventListener('click', addRow);
    exportBtn.addEventListener('click', doExport);
    importFile.addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) doImport(e.target.files[0]); e.target.value=''; });
  }

  if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error)); }
  init();
  </script>
</body>
</html>